#!/bin/bash

pw=$MARIADB_ROOT_PASSWORD;
db=$MARIADB_DATABASE;

version=$(set -e; mysql -BN --user=root --password=$pw $db -e "select \`value\` from \`settings\` where \`name\`='version';" 2> /dev/null);
lines=$(echo $version | sed '/^$/d' | wc -l);

if [[ $lines -eq 0 ]]; then
    mysql --user=root --password=$pw $db < /var/topazdb-src/schema.sql;
else 
    for i in $(seq $((version+1)) $(cat /var/topazdb-src/version)); do
        mysql --user=root --password=$pw $db < /var/topazdb-src/updates/update-$i.sql;
    done
fi